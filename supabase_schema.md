# Supabase Schema v2

This document reflects the current database state after migrating to the PWA version.

## Tables

### `profiles`
Managed via triggers on auth signup.
- `id` (uuid, primary key)
- `username` (text, unique)

### `sessions`
- `id` (bigint, primary key)
- `user_id` (uuid, references profiles)
- `title` (text)
- `date` (date)
- `images` (text array) - Stores public URLs from Supabase Storage.
- `created_at` (timestamp)

## Storage Buckets
- `session-images` (public: true)

## Migration Query
If you need to reset or apply this to a new environment, use the following:

```sql
-- Profiles setup (only if not already present)
create table if not exists public.profiles (
  id uuid references auth.users not null primary key,
  username text unique,
  constraint username_length check (char_length(username) >= 3)
);

-- Sessions setup
create table if not exists public.sessions (
  id bigint generated by default as identity primary key,
  user_id uuid references public.profiles not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  title text not null,
  date date not null default CURRENT_DATE,
  images text[] default array[]::text[]
);

-- RLS & Policies
alter table public.sessions enable row level security;
drop policy if exists "Users can view their own sessions." on public.sessions;
create policy "Users can view their own sessions." on public.sessions for select using (auth.uid() = user_id);
drop policy if exists "Users can insert their own sessions." on public.sessions;
create policy "Users can insert their own sessions." on public.sessions for insert with check (auth.uid() = user_id);
-- ... (other policies)

-- Storage
insert into storage.buckets (id, name, public) values ('session-images', 'session-images', true) on conflict (id) do nothing;
create policy "Authenticated users can upload images" on storage.objects for insert with check ( bucket_id = 'session-images' and auth.role() = 'authenticated' );
create policy "Public can view images" on storage.objects for select using ( bucket_id = 'session-images' );
```